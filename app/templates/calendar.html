{% extends "base.html" %}

{% block title %}Content Calendar - Social Automation{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-2xl font-bold text-gray-900">Content Calendar</h1>
        <p class="mt-2 text-sm text-gray-700">View and manage your scheduled social media posts</p>
    </div>

    <!-- Calendar Controls -->
    <div class="bg-white shadow rounded-lg mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button
                        id="prev-month"
                        class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                    </button>

                    <h2 id="current-month" class="text-lg font-semibold text-gray-900">Loading...</h2>

                    <button
                        id="next-month"
                        class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>

                    <button
                        id="today-btn"
                        class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Today
                    </button>
                </div>

                <div class="flex items-center space-x-3">
                    <!-- Client Filter -->
                    <select
                        id="client-filter"
                        class="block rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm">
                        <option value="">All Clients</option>
                        {% for client in clients %}
                        <option value="{{ client.id }}">{{ client.business_name }}</option>
                        {% endfor %}
                    </select>

                    <!-- Platform Filter -->
                    <select
                        id="platform-filter"
                        class="block rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm">
                        <option value="">All Platforms</option>
                        <option value="facebook">Facebook</option>
                        <option value="instagram">Instagram</option>
                        <option value="linkedin">LinkedIn</option>
                        <option value="google_business">Google Business</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Calendar Grid -->
        <div class="p-6">
            <div class="grid grid-cols-7 gap-px bg-gray-200 rounded-lg overflow-hidden">
                <!-- Day Headers -->
                <div class="bg-gray-50 p-2 text-center text-xs font-semibold text-gray-700">Sun</div>
                <div class="bg-gray-50 p-2 text-center text-xs font-semibold text-gray-700">Mon</div>
                <div class="bg-gray-50 p-2 text-center text-xs font-semibold text-gray-700">Tue</div>
                <div class="bg-gray-50 p-2 text-center text-xs font-semibold text-gray-700">Wed</div>
                <div class="bg-gray-50 p-2 text-center text-xs font-semibold text-gray-700">Thu</div>
                <div class="bg-gray-50 p-2 text-center text-xs font-semibold text-gray-700">Fri</div>
                <div class="bg-gray-50 p-2 text-center text-xs font-semibold text-gray-700">Sat</div>

                <!-- Calendar Days (will be populated by JavaScript) -->
                <div id="calendar-grid" class="col-span-7 grid grid-cols-7 gap-px bg-gray-200">
                    <!-- Days will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="bg-white shadow rounded-lg p-4">
        <h3 class="text-sm font-semibold text-gray-900 mb-3">Platform Legend</h3>
        <div class="flex flex-wrap gap-4">
            <div class="flex items-center">
                <div class="w-3 h-3 rounded-full bg-blue-500 mr-2"></div>
                <span class="text-xs text-gray-600">Facebook</span>
            </div>
            <div class="flex items-center">
                <div class="w-3 h-3 rounded-full bg-pink-500 mr-2"></div>
                <span class="text-xs text-gray-600">Instagram</span>
            </div>
            <div class="flex items-center">
                <div class="w-3 h-3 rounded-full bg-indigo-600 mr-2"></div>
                <span class="text-xs text-gray-600">LinkedIn</span>
            </div>
            <div class="flex items-center">
                <div class="w-3 h-3 rounded-full bg-red-500 mr-2"></div>
                <span class="text-xs text-gray-600">Google Business</span>
            </div>
        </div>
    </div>
</div>

<!-- Post Detail Modal -->
<div id="post-modal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 overflow-y-auto z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-lg font-semibold text-gray-900" id="modal-title">Post Details</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-500">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="modal-content">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
let currentDate = new Date();
let calendarData = [];
let selectedClientId = '';
let selectedPlatform = '';

// Platform colors
const platformColors = {
    facebook: 'bg-blue-500',
    instagram: 'bg-pink-500',
    linkedin: 'bg-indigo-600',
    google_business: 'bg-red-500'
};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadCalendar();

    document.getElementById('prev-month').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        loadCalendar();
    });

    document.getElementById('next-month').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        loadCalendar();
    });

    document.getElementById('today-btn').addEventListener('click', () => {
        currentDate = new Date();
        loadCalendar();
    });

    document.getElementById('client-filter').addEventListener('change', (e) => {
        selectedClientId = e.target.value;
        renderCalendar();
    });

    document.getElementById('platform-filter').addEventListener('change', (e) => {
        selectedPlatform = e.target.value;
        renderCalendar();
    });
});

async function loadCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth() + 1;

    try {
        const response = await fetch(`/admin/calendar/data?year=${year}&month=${month}`);
        calendarData = await response.json();
        renderCalendar();
    } catch (error) {
        console.error('Error loading calendar:', error);
    }
}

function renderCalendar() {
    // Update month display
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('current-month').textContent =
        `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

    // Get calendar grid
    const grid = document.getElementById('calendar-grid');
    grid.innerHTML = '';

    // Calculate first day and number of days
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // Add empty cells for days before month starts
    for (let i = 0; i < firstDay; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'bg-gray-50 min-h-[120px] p-2';
        grid.appendChild(emptyCell);
    }

    // Add day cells
    for (let day = 1; day <= daysInMonth; day++) {
        const dayDate = new Date(year, month, day);
        const dateStr = dayDate.toISOString().split('T')[0];

        const dayCell = document.createElement('div');
        dayCell.className = 'bg-white min-h-[120px] p-2 relative';

        // Highlight today
        if (dayDate.getTime() === today.getTime()) {
            dayCell.classList.add('ring-2', 'ring-indigo-500');
        }

        // Day number
        const dayNumber = document.createElement('div');
        dayNumber.className = 'text-sm font-semibold text-gray-900 mb-1';
        dayNumber.textContent = day;
        dayCell.appendChild(dayNumber);

        // Get posts for this day
        const dayPosts = calendarData.filter(post => {
            const postDate = new Date(post.scheduled_at).toISOString().split('T')[0];

            // Apply filters
            if (selectedClientId && post.client_id != selectedClientId) return false;
            if (selectedPlatform && !post.platforms.includes(selectedPlatform)) return false;

            return postDate === dateStr;
        });

        // Add posts
        const postsContainer = document.createElement('div');
        postsContainer.className = 'space-y-1 overflow-y-auto max-h-[80px]';

        dayPosts.forEach(post => {
            const postEl = document.createElement('div');
            postEl.className = 'text-xs p-1 rounded cursor-move hover:opacity-80 bg-gray-100 border-l-2';
            postEl.style.borderLeftColor = getPlatformColor(post.platforms[0]);
            postEl.draggable = true;
            postEl.dataset.postId = post.id;
            postEl.dataset.scheduledAt = post.scheduled_at;
            postEl.innerHTML = `
                <div class="font-medium text-gray-900 truncate">${post.client_name}</div>
                <div class="text-gray-600 truncate">${post.topic}</div>
                <div class="text-gray-500">${formatTime(post.scheduled_at)}</div>
            `;

            // Drag and drop handlers
            postEl.addEventListener('dragstart', handleDragStart);
            postEl.addEventListener('click', (e) => {
                if (!e.target.closest('[draggable]').dragging) {
                    showPostDetail(post.id);
                }
            });

            postsContainer.appendChild(postEl);
        });

        dayCell.appendChild(postsContainer);

        // Make day cell a drop target
        dayCell.dataset.date = dateStr;
        dayCell.addEventListener('dragover', handleDragOver);
        dayCell.addEventListener('drop', handleDrop);
        dayCell.addEventListener('dragleave', handleDragLeave);

        // Add count badge if more posts
        if (dayPosts.length > 3) {
            const badge = document.createElement('div');
            badge.className = 'absolute bottom-1 right-1 bg-indigo-600 text-white text-xs rounded-full px-2 py-1';
            badge.textContent = `+${dayPosts.length - 3}`;
            dayCell.appendChild(badge);
        }

        grid.appendChild(dayCell);
    }
}

function getPlatformColor(platform) {
    const colors = {
        facebook: '#3b82f6',
        instagram: '#ec4899',
        linkedin: '#4f46e5',
        google_business: '#ef4444'
    };
    return colors[platform] || '#6b7280';
}

function formatTime(datetime) {
    const date = new Date(datetime);
    return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
}

function showPostDetail(postId) {
    const modal = document.getElementById('post-modal');
    const content = document.getElementById('modal-content');

    // Load post details
    fetch(`/admin/content/${postId}`)
        .then(response => response.text())
        .then(html => {
            // Extract just the content part (you may need to adjust this)
            content.innerHTML = `
                <div class="text-sm text-gray-600">
                    <p>Loading post details...</p>
                    <a href="/admin/content/${postId}" class="text-indigo-600 hover:text-indigo-800 mt-2 inline-block">
                        View Full Details â†’
                    </a>
                </div>
            `;
            modal.classList.remove('hidden');
        })
        .catch(error => {
            content.innerHTML = '<p class="text-red-600">Error loading post details</p>';
            modal.classList.remove('hidden');
        });
}

function closeModal() {
    document.getElementById('post-modal').classList.add('hidden');
}

// Close modal on outside click
document.getElementById('post-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

// Drag and drop handlers
let draggedElement = null;

function handleDragStart(e) {
    draggedElement = e.target;
    e.target.dragging = true;
    e.target.style.opacity = '0.4';
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', e.target.innerHTML);
}

function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';

    // Highlight drop target
    const dayCell = e.currentTarget;
    if (dayCell.dataset.date && !dayCell.classList.contains('ring-2')) {
        dayCell.classList.add('ring-2', 'ring-indigo-300', 'bg-indigo-50');
    }

    return false;
}

function handleDragLeave(e) {
    const dayCell = e.currentTarget;
    dayCell.classList.remove('ring-2', 'ring-indigo-300', 'bg-indigo-50');
}

function handleDrop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }

    e.preventDefault();

    const dayCell = e.currentTarget;
    dayCell.classList.remove('ring-2', 'ring-indigo-300', 'bg-indigo-50');

    if (draggedElement) {
        const postId = draggedElement.dataset.postId;
        const oldScheduledAt = draggedElement.dataset.scheduledAt;
        const newDate = dayCell.dataset.date;

        if (!newDate) return false;

        // Get the time from the old scheduled_at
        const oldDate = new Date(oldScheduledAt);
        const hours = oldDate.getHours();
        const minutes = oldDate.getMinutes();

        // Create new datetime with same time, different date
        const newDateTime = new Date(newDate);
        newDateTime.setHours(hours, minutes, 0, 0);

        // Update the post
        reschedulePost(postId, newDateTime.toISOString());

        draggedElement.style.opacity = '1';
        draggedElement.dragging = false;
        draggedElement = null;
    }

    return false;
}

async function reschedulePost(postId, newScheduledAt) {
    try {
        const response = await fetch(`/admin/content/${postId}/reschedule`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                scheduled_at: newScheduledAt
            })
        });

        if (response.ok) {
            // Reload calendar to show updated position
            loadCalendar();
            showToast('Post rescheduled successfully', 'success');
        } else {
            showToast('Failed to reschedule post', 'error');
        }
    } catch (error) {
        console.error('Error rescheduling:', error);
        showToast('Error rescheduling post', 'error');
        loadCalendar(); // Reload to revert changes
    }
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    if (!container) return;

    const toast = document.createElement('div');
    const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';

    toast.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300`;
    toast.textContent = message;

    container.appendChild(toast);

    setTimeout(() => {
        toast.classList.add('opacity-0');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
</script>
{% endblock %}
